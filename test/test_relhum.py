import unittest
import pytest

import numpy as np
from geocat.comp.relhum import relhum

rh_gt_1 = 46.4

rh_gt_2 = [79.8228, 79.3578, 84.1962, 79.4898, 73.989,
           69.2401, 66.1896, 61.1084, 64.21, 63.8305,
           58.0412, 60.8194, 57.927, 62.3734, 62.9706,
           73.8184, 62.71, 0, 0, 0, 0, 0, 0, 0, 0,
           0, 0, 0, 0, 0]


class Ttest_relhum(unittest.TestCase):
    def test_single_run(self):
        p = 1000. * 100
        t = 18. + 273.15
        q = 6. / 1000.

        assert relhum(t, q, p) == pytest.approx(rh_gt_1, 0.1)

    def test_array_run(self):
        p = [100800, 100000, 95000, 90000, 85000,
             80000, 75000, 70000, 65000, 60000,
             55000, 50000, 45000, 40000, 35000,
             30000, 25000, 20000, 17500, 15000,
             12500, 10000, 8000, 7000, 6000,
             5000, 4000, 3000, 2500, 2000]
        t = [302.45, 301.25, 296.65, 294.05, 291.55,
             289.05, 286.25, 283.25, 279.85, 276.25,
             272.65, 268.65, 264.15, 258.35, 251.65,
             243.45, 233.15, 220.75, 213.95, 206.65,
             199.05, 194.65, 197.15, 201.55, 206.45,
             211.85, 216.85, 221.45, 222.45, 225.65]
        q = [0.02038, 0.01903, 0.01614, 0.01371, 0.01156,
             0.0098, 0.00833, 0.00675, 0.00606, 0.00507,
             0.00388, 0.00329, 0.00239, 0.0017, 0.001,
             0.0006, 0.0002, 0, 0, 0, 0, 0, 0, 0, 0, 0,
             0, 0, 0, 0]

        assert np.allclose(relhum(t, q, p), rh_gt_2, atol=0.1)

    def test_numpy_input(self):
        p = np.asarray([100800, 100000, 95000, 90000, 85000,
                        80000, 75000, 70000, 65000, 60000,
                        55000, 50000, 45000, 40000, 35000,
                        30000, 25000, 20000, 17500, 15000,
                        12500, 10000, 8000, 7000, 6000,
                        5000, 4000, 3000, 2500, 2000])
        t = np.asarray([302.45, 301.25, 296.65, 294.05, 291.55,
                        289.05, 286.25, 283.25, 279.85, 276.25,
                        272.65, 268.65, 264.15, 258.35, 251.65,
                        243.45, 233.15, 220.75, 213.95, 206.65,
                        199.05, 194.65, 197.15, 201.55, 206.45,
                        211.85, 216.85, 221.45, 222.45, 225.65])
        q = np.asarray([0.02038, 0.01903, 0.01614, 0.01371, 0.01156,
                        0.0098, 0.00833, 0.00675, 0.00606, 0.00507,
                        0.00388, 0.00329, 0.00239, 0.0017, 0.001,
                        0.0006, 0.0002, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                        0, 0, 0, 0])

        assert np.allclose(relhum(t, q, p), rh_gt_2, atol=0.1)
